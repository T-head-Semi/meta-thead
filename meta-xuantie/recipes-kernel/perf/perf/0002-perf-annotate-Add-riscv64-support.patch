From a0a94eba632a6686f96c67171da96fc29920f8f1 Mon Sep 17 00:00:00 2001
From: "hanyu.cp" <hanyu.cp@alibaba-inc.com>
Date: Mon, 30 Oct 2023 15:35:17 +0800
Subject: [PATCH] perf annotate: Add riscv64 support

https://github.com/torvalds/linux/commit/0ba37e05c240c7b38e5a327a96f404798a8698ff

Signed-off-by: hanyu.cp <hanyu.cp@alibaba-inc.com>
---
 .../perf/arch/riscv64/annotate/instructions.c | 34 +++++++++++++++++++
 tools/perf/util/annotate.c                    |  5 +++
 2 files changed, 39 insertions(+)
 create mode 100644 tools/perf/arch/riscv64/annotate/instructions.c

diff --git a/tools/perf/arch/riscv64/annotate/instructions.c b/tools/perf/arch/riscv64/annotate/instructions.c
new file mode 100644
index 000000000000..a3b7b3180114
--- /dev/null
+++ b/tools/perf/arch/riscv64/annotate/instructions.c
@@ -0,0 +1,34 @@
+// SPDX-License-Identifier: GPL-2.0
+
+static
+struct ins_ops *riscv64__associate_ins_ops(struct arch *arch, const char *name)
+{
+	struct ins_ops *ops = NULL;
+
+	if (!strncmp(name, "jal", 3) ||
+	    !strncmp(name, "jr", 2) ||
+	    !strncmp(name, "call", 4))
+		ops = &call_ops;
+	else if (!strncmp(name, "ret", 3))
+		ops = &ret_ops;
+	else if (name[0] == 'j' || name[0] == 'b')
+		ops = &jump_ops;
+	else
+		return NULL;
+
+	arch__associate_ins_ops(arch, name, ops);
+
+	return ops;
+}
+
+static
+int riscv64__annotate_init(struct arch *arch, char *cpuid __maybe_unused)
+{
+	if (!arch->initialized) {
+		arch->associate_instruction_ops = riscv64__associate_ins_ops;
+		arch->initialized = true;
+		arch->objdump.comment_char = '#';
+	}
+
+	return 0;
+}
\ No newline at end of file
diff --git a/tools/perf/util/annotate.c b/tools/perf/util/annotate.c
index 6ab9a5c6f651..95a825b99392 100644
--- a/tools/perf/util/annotate.c
+++ b/tools/perf/util/annotate.c
@@ -154,6 +154,7 @@ static int arch__associate_ins_ops(struct arch* arch, const char *name, struct i
 #include "arch/csky/annotate/instructions.c"
 #include "arch/x86/annotate/instructions.c"
 #include "arch/powerpc/annotate/instructions.c"
+#include "arch/riscv64/annotate/instructions.c"
 #include "arch/s390/annotate/instructions.c"
 #include "arch/sparc/annotate/instructions.c"
 
@@ -188,6 +189,10 @@ static struct arch architectures[] = {
 		.name = "powerpc",
 		.init = powerpc__annotate_init,
 	},
+	{
+		.name = "riscv64",
+		.init = riscv64__annotate_init,
+	},
 	{
 		.name = "s390",
 		.init = s390__annotate_init,
-- 
2.17.1

